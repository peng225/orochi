services:
  postgres:
    image: postgres:18
    container_name: postgres
    networks:
      - testnet
    ports:
      - 5432:5432
    environment:
      - POSTGRES_USER=testuser
      - POSTGRES_PASSWORD=testpass
      - POSTGRES_DB=orochi
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB} -h localhost -p 5432"]
      interval: 1s
      timeout: 3s
      retries: 10
      start_period: 10s
  initdb:
    image: postgres:18
    container_name: initdb
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - testnet
    volumes:
      - ../internal/gateway/infra/postgresql/sqlc:/schema/gateway
      - ../internal/manager/infra/postgresql/sqlc:/schema/manager
    entrypoint: >
      bash -c "
        echo 'Initializing database...';
        psql 'postgresql://testuser:testpass@postgres:5432/orochi' -f /schema/gateway/schema.sql;
        psql 'postgresql://testuser:testpass@postgres:5432/orochi' -f /schema/manager/schema.sql;
        echo 'Database initialized successfully.';
      "
    restart: "no"
  manager:
    image: ghcr.io/peng225/orochi:latest
    container_name: manager
    depends_on:
      initdb:
        condition: service_completed_successfully
    command: ["manager", "-p", "8080"]
    networks:
      - testnet
    ports:
      - 8080:8080
    environment:
      - DSN=host=postgres port=5432 user=testuser password=testpass dbname=orochi sslmode=disable
  datastore0:
    build:
      context: ..
    image: ghcr.io/peng225/orochi:latest
    container_name: datastore0
    depends_on:
      manager:
        condition: service_started
    command:
      - "datastore"
      - "--base-url=http://datastore0:8082"
      - "--manager-base-url=http://manager:8080"
      - "--log-level=debug"
    networks:
      - testnet
    ports:
      - 8082:8082
    volumes:
      - ./data/datastore0:/data
  datastore1:
    image: ghcr.io/peng225/orochi:latest
    container_name: datastore1
    depends_on:
      manager:
        condition: service_started
    command:
      - "datastore"
      - "--base-url=http://datastore1:8083"
      - "--manager-base-url=http://manager:8080"
      - "--log-level=debug"
    networks:
      - testnet
    ports:
      - 8083:8083
    volumes:
      - ./data/datastore1:/data
  datastore2:
    image: ghcr.io/peng225/orochi:latest
    container_name: datastore2
    depends_on:
      manager:
        condition: service_started
    command:
      - "datastore"
      - "--base-url=http://datastore2:8084"
      - "--manager-base-url=http://manager:8080"
      - "--log-level=debug"
    networks:
      - testnet
    ports:
      - 8084:8084
    volumes:
      - ./data/datastore2:/data
  datastore3:
    image: ghcr.io/peng225/orochi:latest
    container_name: datastore3
    depends_on:
      manager:
        condition: service_started
    command:
      - "datastore"
      - "--base-url=http://datastore3:8085"
      - "--manager-base-url=http://manager:8080"
      - "--log-level=debug"
    networks:
      - testnet
    ports:
      - 8085:8085
    volumes:
      - ./data/datastore3:/data
  gateway:
    image: ghcr.io/peng225/orochi:latest
    container_name: gateway
    depends_on:
      datastore0:
        condition: service_started
      datastore1:
        condition: service_started
      datastore2:
        condition: service_started
      initdb:
        condition: service_completed_successfully
    command:
      - "gateway"
      - "-p=8081"
      - "--log-level=debug"
      - "--manager-base-url=http://manager:8080"
    networks:
      - testnet
    ports:
      - 8081:8081
    environment:
      - DSN=host=postgres port=5432 user=testuser password=testpass dbname=orochi sslmode=disable
  async:
    image: ghcr.io/peng225/orochi:latest
    container_name: async
    depends_on:
      initdb:
        condition: service_completed_successfully
    command: ["async", "--period", "1s", "--gateway-base-url", "http://gateway:8081", "--log-level", "debug"]
    networks:
      - testnet
    environment:
      - DSN=host=postgres port=5432 user=testuser password=testpass dbname=orochi sslmode=disable

networks:
  testnet:
    driver: bridge
